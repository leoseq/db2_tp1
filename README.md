# TRABAJO TRACTICO NRO 1 - BASE DE DATOS II

### PROCEDIMIENTOS Y DISPARADORES
***Autor:*** Leonardo Ariel Sequeira <br>
***Legajo:*** 112776 <br>


#### TABLAS
```sql
CREATE TABLE TABLA_FACTURA
(
    NRO INT NOT NULL PRIMARY KEY,
    IMPORTE FLOAT NOT NULL
);

CREATE TABLE TABLA_PRODUCTO
(
    ID INT NOT NULL PRIMARY KEY,
    DESCR VARCHAR(100) NOT NULL,
    STOCK INT NOT NULL
);

CREATE TABLE TABLA_DETALLE
(
    NRO INT NOT NULL,
    ID INT NOT NULL,
    CANTIDAD INT NOT NULL,
    PRECIO FLOAT NOT NULL,
    
    PRIMARY KEY (NRO, ID),
            
    CONSTRAINT FK_DETALLE_FACTURA FOREIGN KEY (NRO) REFERENCES TABLA_FACTURA (NRO),
    CONSTRAINT FK_DETALLE_PRODUCTO FOREIGN KEY (ID) REFERENCES TABLA_PRODUCTO (ID)
);

ALTER TABLE TABLA_PRODUCTO
ADD PRECIO FLOAT NOT NULL;

ALTER TABLE TABLA_PRODUCTO
ADD PRECIO_COSTO FLOAT NOT NULL;

ALTER TABLE TABLA_FACTURA
ADD ESTADO SMALLINT DEFAULT 0 NOT NULL;

ALTER TABLE TABLA_FACTURA
ADD FECHA DATE;

```

#### GENERATORS
```sql
CREATE GENERATOR GEN_NRO_FACTURA;
SET GENERATOR GEN_NRO_FACTURA TO 1;

CREATE GENERATOR GEN_ID_PRODUCTO;
SET GENERATOR GEN_ID_PRODUCTO TO 1;

```

#### EXCEPTIONS
```sql
CREATE EXCEPTION EX_PRODUCTO_ID 'NO SE PUEDE CAMBIAR EL ID DEL PRODUCTO';

CREATE EXCEPTION EX_FACTURA_NRO 'NO SE PUEDE CAMBIAR EL NRO DE LA FACTURA';

```

#### TRIGGERS

| EVENTO | TIPO | SOBRE TABLA | TAREA QUE REALIZA |
| :---------: | :---------: | :---------: | :---------: |
| INSERT | BEFORE | PRODUCTO | AUTOINCREMENTAR EL VALOR DE ID DE LA TABLA PRODUCTO EN 1 |
| UPDATE | BEFORE | PRODUCTO | NO PERMITIR EL CAMBIO DE ID DEL PRODUCTO |
| INSERT | BEFORE | FACTURA | AUTOINCREMENTAR EL VALOR DEL NRO DE LA FACTURA EN 1 |
| UPDATE | BEFORE | FACTURA | NO PERMITIR EL CAMBIO DE NRO DE LA FACTURA |

```sql
SET TERM ^ ;

CREATE TRIGGER TRG_BI_PRODUCTO FOR TABLA_PRODUCTO 
 ACTIVE BEFORE INSERT POSITION 0 
AS 
BEGIN 
    NEW.ID = GEN_ID(GEN_ID_PRODUCTO, 1);
END^

CREATE TRIGGER TRG_BI_FACTURA FOR TABLA_FACTURA 
 ACTIVE BEFORE INSERT POSITION 0 
AS 
BEGIN 
    NEW.NRO = GEN_ID(GEN_NRO_FACTURA, 1);
END^

CREATE TRIGGER TRG_BU_PRODUCTO FOR TABLA_PRODUCTO 
 ACTIVE BEFORE UPDATE POSITION 0
AS 
BEGIN 
    IF (NEW.ID <> OLD.ID) THEN 
        EXCEPTION EX_PRODUCTO_ID;
END^

CREATE TRIGGER TRG_BU_FACTURA FOR TABLA_FACTURA 
 ACTIVE BEFORE UPDATE POSITION 0
AS 
BEGIN 
    IF (NEW.NRO <> OLD.NRO) THEN 
        EXCEPTION EX_FACTURA_NRO;
END^

SET TERM ; ^

```
