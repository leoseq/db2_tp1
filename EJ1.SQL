----------------------------------------------------------
-- TABLES
----------------------------------------------------------

CREATE TABLE TABLA_FACTURA
(
    NRO INT NOT NULL PRIMARY KEY,
    IMPORTE FLOAT NOT NULL
);

CREATE TABLE TABLA_PRODUCTO
(
    ID INT NOT NULL PRIMARY KEY,
    DESCR VARCHAR(100) NOT NULL,
    STOCK INT NOT NULL
);

CREATE TABLE TABLA_DETALLE
(
    NRO INT NOT NULL,
    ID INT NOT NULL,
    CANTIDAD INT NOT NULL,
    PRECIO FLOAT NOT NULL,
    
    PRIMARY KEY (NRO, ID),
            
    CONSTRAINT FK_DETALLE_FACTURA FOREIGN KEY (NRO) REFERENCES TABLA_FACTURA (NRO),
    CONSTRAINT FK_DETALLE_PRODUCTO FOREIGN KEY (ID) REFERENCES TABLA_PRODUCTO (ID)
);

ALTER TABLE TABLA_PRODUCTO
ADD PRECIO FLOAT NOT NULL;

ALTER TABLE TABLA_PRODUCTO
ADD PRECIO_COSTO FLOAT NOT NULL;

ALTER TABLE TABLA_FACTURA
ADD ESTADO SMALLINT DEFAULT 0 NOT NULL;

ALTER TABLE TABLA_FACTURA
ADD FECHA DATE;

----------------------------------------------------------
-- GENERATORS
----------------------------------------------------------

CREATE GENERATOR GEN_NRO_FACTURA;
SET GENERATOR GEN_NRO_FACTURA TO 1;

CREATE GENERATOR GEN_ID_PRODUCTO;
SET GENERATOR GEN_ID_PRODUCTO TO 1;


----------------------------------------------------------
-- EXCEPTIONS
----------------------------------------------------------

CREATE EXCEPTION EX_PRODUCTO_ID 'NO SE PUEDE CAMBIAR EL ID DEL PRODUCTO';
CREATE EXCEPTION EX_FACTURA_NRO 'NO SE PUEDE CAMBIAR EL NRO DE LA FACTURA';

----------------------------------------------------------
-- TRIGGERS
----------------------------------------------------------

SET TERM ^ ;

CREATE TRIGGER TRG_BI_PRODUCTO FOR TABLA_PRODUCTO 
 ACTIVE BEFORE INSERT POSITION 0 
AS 
BEGIN 
    NEW.ID = GEN_ID(GEN_ID_PRODUCTO, 1);
END^

CREATE TRIGGER TRG_BI_FACTURA FOR TABLA_FACTURA 
 ACTIVE BEFORE INSERT POSITION 0 
AS 
BEGIN 
    NEW.NRO = GEN_ID(GEN_NRO_FACTURA, 1);
END^

CREATE TRIGGER TRG_BU_PRODUCTO FOR TABLA_PRODUCTO 
 ACTIVE BEFORE UPDATE POSITION 0
AS 
BEGIN 
    IF (NEW.ID <> OLD.ID) THEN 
        EXCEPTION EX_PRODUCTO_ID;
END^

CREATE TRIGGER TRG_BU_FACTURA FOR TABLA_FACTURA 
 ACTIVE BEFORE UPDATE POSITION 0
AS 
BEGIN 
    IF (NEW.NRO <> OLD.NRO) THEN 
        EXCEPTION EX_FACTURA_NRO;
END^

SET TERM ; ^

